# Kỹ thuật phân tích tĩnh cơ bản cho phân tích mã độc.
Có 2 kỹ thuật chính để phân tích mã độc là *phân tích động (dynamic)* và *phân tích tĩnh (static)*. Phân tích tĩnh liên quan tới việc phân tích mã độc mà không thực thi nó, phân tích mà phải thực thi mã độc thì được gọi là phân tích động.  
## Sử dụng Antivirus  
- Đây được xem là bước khởi đầu trong việc phân tích. Chạy tệp cần phân tích thông qua nhiều bộ công cụ Antivirus có thể giúp chúng ta nhận diện được mã độc.  
- Chúng nhận diện được mã độc dựa trên một tập dữ liệu có sẵn chứa những đoạn code (file signature), những hành vi, những khuôn mẫu (pattern), dựa vào tập dữ liệu này, antivirus sẽ quyết định xem chương trình đang kiểm tra có khả năng là mã độc hay không.  
- Tuy nhiên, những bộ công cụ này không thật sử hoàn hảo do giới hạn của kích thước tập dữ liệu cũng như thời gian cập nhật tập dữ liệu này. Trong khi tác giả của mã độc có thể dễ dàng sửa đổi code và chữ ký của chương trình để trốn tránh Antivirus. Do đó, đối với những mã độc mới, hay những mã độc tinh vi, lạ thì Antivirus hoàn toàn chịu thua.  
- Để tăng tính chính xác khi sử dụng antivirus, chúng ta nên kiểm tra tệp tin trên nhiều công cụ khác nhau. Trang [VirusTotal](https://www.virustotal.com/gui/)  hỗ trợ khá tốt cho việc này.  

## Hashing: A Fingerprint for Malware  
Kỹ thuật này thường dùng cho những mã độc được xem là duy nhất (độc nhất vô nhị). Chúng ta dùng hàm băm (hash) để băm nó ra thành những chuỗi hash duy nhất đại diện cho nó.  
Sau khi có chuỗi này, ta có thể :  
    - Dùng chuỗi này như 1 label, 
    - Gửi cho những chuyên gia phân tích khác nhờ họ giúp.  
    - Thậm chí có thể tìm kiếm trên internet loại mã độc này thông qua chuỗi hash trên.  

## Tìm chuỗi  
- Đây là cách đơn giản để lấy được thông tin cơ bản về chức năng của mã độc. Những chuỗi này có thể là một đoạn thông báo, có thể là tên hàm, có thể là địa chỉ tên miền nào đó...  
- Ví dụ, khi phân tích chuôi của 1 chương trình, ta có các chuỗi sau:  
```
VP3
VW3
t$@
D$4
99.124.22.1
e-@
GetLayout
GDI32.DLL
SetLayout
M}C
Mail system DLL is invalid.!Send Mail failed to send message
```
Trong ví dụ trên, có những chuỗi có nghĩa và cũng có những chuỗi vô nghĩa (VP3, VW3,...). Ta có:  
    - **GetLayout** và **SetLayout** là những hàm được dùng bởi thư viện đồ họa của Windows.  
    - **GDI.DLL** là tên của thư viện liên kết động (dynamic link library) được sử dụng bởi những chương trình đồ họa.  
    - **99.124.22.1** có thể là 1 địa chỉ IP nào đó.
    - **Mail system DLL is invalid.!Send Mail failed to send message** rõ ràng đây là một thông báo lỗi.  
Từ những yếu tố trên, ta có thể dẫn tới kết luận: Mã độc này thực hiện thao tác gửi 1 message (có thể là gửi qua mail) và nó phụ thuộc vào hệ thống mail DLL (thông báo lỗi).  
Từ đó, ta có thể cần phải kiểm tra email log đối với những traffic đáng nghi ngờ, haowjc kiểm tra những DLL khác có thể có liên quan đến mã độc này (như Mail system DLL)  
## Packed và Obfuscated 
- **Obfuscated programs** là những chương trình mà các lệnh thực thi của nó đã bị tác giả cố gắng giấu đi, làm rối để chúng ta khó có thể dịch ngược lại từ binary ban đầu.  
- **Packed program** là tập hợp nhiều Obfuscated programs và mã độc đã bị nén (compress), không thể phân tích.  
Kỹ thuật này mục đích là giúp tác giả của các ứng dụng, phần mềm bảo vệ sản phẩm của họ, không bị ăn cắp, ý tưởng, bản quyền. Tuy nhiên, nó lại bị các tin tặc sử dụng khi viết mã độc, làm khó khăn trong quá trình phân tích chúng, đặc biệt khi chúng ta phân tích tĩnh, kỹ thuật này gây ra rất nhiều khó khăn.  
- Một trong những cách để phát hiện Packers đó là dùng *công cụ PEiD*. Mặc dù công cụ này đã không còn tiếp tục phát triển từ 2011, nhưng ở một khía cạnh nào đó, nó vẫn là một công cụ mạnh để phát hiện packer. Ngoài ra chúng ta có thể nhận diện bằng string, bằng kinh nghiệm của bản thân,...  
- Sau khi phát hiện ra packer, chúng ta cần unpack chúng. Tool [UPX](http://
upx.sourceforge.net/) có thể hỗ trợ chúng ta trong việc này. Tuy nhiên, có những trường hợp công cụ này không hữu hiệu, khi đó chúng ta phải unpack bằng tay.  

## Linked Libraries and Functions  
Đây là mẫu thông tin hữu ích cho việc phân tích nếu chúng ta có được chúng.  
- **Import** là những hàm được sử dụng trong chương trình mà code thực thi của nó lại nằm trong chương trình khác. Quá trình chương trình đang thực thi gọi những hàm này từ chương trình khác gọi là **linking**.  Chúng ta có các loại linking như:  
    - *Static linking*: phương pháp thường dùng trong các chương trình Linux, UNIX. Khi một library linking tới file thực thi (executable) thì nó sẽ copy tất cả các code của library bỏ vào file thực thi, sau đó mới thực thi file này. Phương pháp này làm cho kích thước của file tăng lên, gây khó khăn khi phân tích vì không phân biệt được code nào của file thực thi, code nào của thư viện hỗ trơ. Tuy nhiên, phương pháp này không thường hay sử dụng để viết mã độc, vì dễ bị phát hiện do kích thước tăng đáng kể.  
    - *Runtime linking*: thường được dùng trong viết mã độc, đặc biệt là mã độc có sử dụng kỹ thuật packed và obfuscated. Chương trình thực thi sẽ thực hiện bình thường, đến khi nào cần dùng hàm ở trong thư viện thì nó mới copy đoạn mã thực thi của hàm đó bỏ vào rồi thực thi tiếp.  
    - *Dynamic linking*: khi thực hiện phương pháp này, hệ điều hành sẽ tìm những thư viện đã được liên kết với chương trình thực thi, khi chương trình thực thi đến những hàm được liên kết, hệ điều hành sẽ chuyển qua thực thi trong thư viện rồi trả kết quả về cho chương trình thực thi để tiếp tục. Phương pháp này thường được sử dụng nhiều nhất trong viết mã độc và phân tích mã độc.  
PE file header lưu thông tin về những thư viện được load và những hàm sẽ được sử dụng bởi chương trình. Đối với mã độc, thường những thư viện, hàm được gọi này là những phần rất quan trọng. Do đó, phát hiện chúng có thể giúp chúng ta dự đoán được hành vi của chương trình đang phân tích.  
## Ví dụ về phân mã độc bằng phương pháp tĩnh.  